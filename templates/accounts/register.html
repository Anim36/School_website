{% extends 'base.html' %}

{% block title %}Register - School Management System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0 text-center"><i class="fas fa-user-plus"></i> Create New Account</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Please correct the following errors:</strong>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Form errors display section এর পরে এটি add করুন -->
                    <div class="alert alert-warning">
                        <h6>Debug Information:</h6>
                        <pre>{{ form.errors.as_json }}</pre>
                    </div>
                    {% endif %}

                    <h5 class="mb-3 text-primary">Account Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_username" class="form-label">Username *</label>
                                {{ form.username }}
                                <div class="form-text">Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_email" class="form-label">Email Address *</label>
                                {{ form.email }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_first_name" class="form-label">First Name *</label>
                                {{ form.first_name }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_last_name" class="form-label">Last Name *</label>
                                {{ form.last_name }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_user_type" class="form-label">Account Type *</label>
                                {{ form.user_type }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_phone" class="form-label">Phone Number</label>
                                {{ form.phone }}
                            </div>
                        </div>
                    </div>

                    <!-- Address Field for All Users -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="id_address" class="form-label">
                                    <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                    Address
                                </label>
                                <textarea name="address" id="id_address" class="form-control" rows="3"
                                          placeholder="Enter your complete residential address including house number, road, area, city, and postal code"></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    This address will be displayed in your profile
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Specific Fields -->
                    <div id="student-fields" style="display: {% if form.user_type.value == 'student' %}block{% else %}none{% endif %};">
                        <h5 class="mb-3 text-primary mt-4">Student Information</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_gender" class="form-label">Gender *</label>
                                    <select name="gender" id="id_gender" class="form-select" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                    <div class="form-text">This will be shown in your profile</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_date_of_birth" class="form-label">Date of Birth *</label>
                                    <input type="date" name="date_of_birth" id="id_date_of_birth" class="form-control" required>
                                    <div class="form-text">Format: YYYY-MM-DD</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_class_name" class="form-label">Class *</label>
                                    <select name="class_name" id="id_class_name" class="form-select" required>
                                        <option value="">Select Class</option>
                                        <option value="Class 1">Class 1</option>
                                        <option value="Class 2">Class 2</option>
                                        <option value="Class 3">Class 3</option>
                                        <option value="Class 4">Class 4</option>
                                        <option value="Class 5">Class 5</option>
                                        <option value="Class 6">Class 6</option>
                                        <option value="Class 7">Class 7</option>
                                        <option value="Class 8">Class 8</option>
                                        <option value="Class 9">Class 9</option>
                                        <option value="Class 10">Class 10</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_section" class="form-label">Section *</label>
                                    <select name="section" id="id_section" class="form-select" required>
                                        <option value="">Select Section</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_roll_number" class="form-label">Roll Number *</label>
                                    <input type="number" name="roll_number" id="id_roll_number" class="form-control" min="1"
                                           placeholder="Enter roll number" required>
                                    <div class="form-text">Must be unique in your class</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 text-info mt-4">
                            <i class="fas fa-users me-2"></i>Parent/Guardian Information
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_father_name" class="form-label">Father's Name *</label>
                                    <input type="text" name="father_name" id="id_father_name" class="form-control"
                                           placeholder="Father's full name" required>
                                    <div class="form-text">This will be displayed in your profile</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_mother_name" class="form-label">Mother's Name *</label>
                                    <input type="text" name="mother_name" id="id_mother_name" class="form-control"
                                           placeholder="Mother's full name" required>
                                    <div class="form-text">This will be displayed in your profile</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_parent_phone" class="form-label">Parent's Phone *</label>
                                    <input type="text" name="parent_phone" id="id_parent_phone" class="form-control"
                                           placeholder="Parent's phone number" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_parent_email" class="form-label">Parent's Email</label>
                                    <input type="email" name="parent_email" id="id_parent_email" class="form-control"
                                           placeholder="Parent's email address">
                                </div>
                            </div>
                        </div>

                        <!-- Parent Address Section -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="id_parent_address" class="form-label">
                                        <i class="fas fa-home me-2 text-success"></i>
                                        Parent's Address
                                    </label>
                                    <textarea name="parent_address" id="id_parent_address" class="form-control" rows="2"
                                              placeholder="Enter parent's residential address (if different from yours)"></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1 text-info"></i>
                                        This address will be shown in your student profile
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Teacher Specific Fields -->
                    <div id="teacher-fields" style="display: {% if form.user_type.value == 'teacher' %}block{% else %}none{% endif %};">
                        <h5 class="mb-3 text-primary mt-4">Teacher Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_teacher_gender" class="form-label">Gender *</label>
                                    <select name="teacher_gender" id="id_teacher_gender" class="form-select" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                    <div class="form-text">This will be shown in your profile</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_teacher_dob" class="form-label">Date of Birth *</label>
                                    <input type="date" name="teacher_dob" id="id_teacher_dob" class="form-control" required>
                                    <div class="form-text">This will be shown in your profile</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_qualification" class="form-label">Qualification *</label>
                                    <input type="text" name="qualification" id="id_qualification" class="form-control"
                                           placeholder="e.g., M.A., B.Ed., M.Sc., etc." required>
                                    <div class="form-text">This will be displayed in your profile</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_specialization" class="form-label">Specialization *</label>
                                    <input type="text" name="specialization" id="id_specialization" class="form-control"
                                           placeholder="e.g., Mathematics, Science, English, etc." required>
                                    <div class="form-text">This will be displayed in your profile</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3 text-primary mt-4">Security Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_password1" class="form-label">Password *</label>
                                {{ form.password1 }}
                                <div class="form-text">
                                    <ul class="small">
                                        <li>Your password can't be too similar to your other personal information.</li>
                                        <li>Your password must contain at least 8 characters.</li>
                                        <li>Your password can't be a commonly used password.</li>
                                        <li>Your password can't be entirely numeric.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_password2" class="form-label">Confirm Password *</label>
                                {{ form.password2 }}
                                <div class="form-text">Enter the same password as before, for verification.</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                        <label class="form-check-label" for="agreeTerms">
                            I agree that all information provided is accurate and will be displayed in my profile.
                            I accept the <a href="#" class="text-decoration-none">Terms and Conditions</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                        </label>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <p>Already have an account? <a href="{% url 'login' %}" class="text-decoration-none">Login here</a></p>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body text-center">
                <h6>Quick Registration</h6>
                <p class="text-muted small mb-3">Select your account type to see relevant fields</p>
                <div class="btn-group w-100 mt-2">
                    <button type="button" class="btn btn-outline-primary user-type-btn" data-type="student">
                        <i class="fas fa-user-graduate me-2"></i>Student
                    </button>
                    <button type="button" class="btn btn-outline-success user-type-btn" data-type="teacher">
                        <i class="fas fa-chalkboard-teacher me-2"></i>Teacher
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userTypeSelect = document.getElementById('id_user_type');
    const studentFields = document.getElementById('student-fields');
    const teacherFields = document.getElementById('teacher-fields');
    const userTypeBtns = document.querySelectorAll('.user-type-btn');

    function toggleFields() {
        const selectedType = userTypeSelect.value;

        // Show/hide student fields
        if (selectedType === 'student') {
            studentFields.style.display = 'block';
            teacherFields.style.display = 'none';
        }
        // Show/hide teacher fields
        else if (selectedType === 'teacher') {
            studentFields.style.display = 'none';
            teacherFields.style.display = 'block';
        }
        // Hide both for other types
        else {
            studentFields.style.display = 'none';
            teacherFields.style.display = 'none';
        }

        // Update button states
        userTypeBtns.forEach(btn => {
            if (btn.getAttribute('data-type') === selectedType) {
                btn.classList.remove('btn-outline-primary', 'btn-outline-success');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                if (btn.getAttribute('data-type') === 'student') {
                    btn.classList.add('btn-outline-primary');
                } else {
                    btn.classList.add('btn-outline-success');
                }
            }
        });
    }

    userTypeSelect.addEventListener('change', toggleFields);

    userTypeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            userTypeSelect.value = type;
            toggleFields();
        });
    });

    // Form validation for required fields
    const registrationForm = document.querySelector('form');
    registrationForm.addEventListener('submit', function(e) {
        const userType = userTypeSelect.value;
        let isValid = true;
        let errorMessage = '';

        if (userType === 'student') {
            const gender = document.getElementById('id_gender').value;
            const dob = document.getElementById('id_date_of_birth').value;
            const className = document.getElementById('id_class_name').value;
            const section = document.getElementById('id_section').value;
            const rollNumber = document.getElementById('id_roll_number').value;
            const fatherName = document.getElementById('id_father_name').value;
            const motherName = document.getElementById('id_mother_name').value;
            const parentPhone = document.getElementById('id_parent_phone').value;

            if (!gender || !dob || !className || !section || !rollNumber || !fatherName || !motherName || !parentPhone) {
                isValid = false;
                errorMessage = 'Please fill all required student information: Gender, Date of Birth, Class, Section, Roll Number, Father\'s Name, Mother\'s Name, and Parent\'s Phone.';
            }
        }
        else if (userType === 'teacher') {
            const gender = document.getElementById('id_teacher_gender').value;
            const dob = document.getElementById('id_teacher_dob').value;
            const qualification = document.getElementById('id_qualification').value;
            const specialization = document.getElementById('id_specialization').value;

            if (!gender || !dob || !qualification || !specialization) {
                isValid = false;
                errorMessage = 'Please fill all required teacher information: Gender, Date of Birth, Qualification, and Specialization.';
            }
        }

        if (!isValid) {
            e.preventDefault();
            alert(errorMessage);
            return false;
        }
    });

    // Initial toggle
    toggleFields();
});
</script>

<style>
.user-type-btn {
    transition: all 0.3s ease;
}

.user-type-btn:hover {
    transform: translateY(-2px);
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 10px 15px;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    transform: translateY(-1px);
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.btn-lg {
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 10px;
}

.alert {
    border-radius: 10px;
    border: none;
}

.alert-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

/* Address textarea styling */
textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* Responsive design */
@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
    }

    .user-type-btn {
        margin-bottom: 5px;
        border-radius: 8px !important;
    }

    .card-body {
        padding: 1rem;
    }
}

/* Form section styling */
h5.text-primary, h6.text-info {
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

h6.text-info {
    border-color: #0dcaf0;
    color: #0dcaf0 !important;
}

.form-text {
    font-size: 0.85rem;
    color: #6c757d;
}
</style>
{% endblock %}