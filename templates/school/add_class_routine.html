{% extends 'base.html' %}

{% block title %}Add Class Routine - School Management System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0"><i class="fas fa-plus"></i> Add Class Routine</h4>
            </div>
            <div class="card-body">
                <!-- Debug Information -->
                {% if user.user_type == 'teacher' %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Teacher Information</h6>
                    <p class="mb-0">
                        <strong>Teacher:</strong> {{ user.get_full_name }}<br>
                        <strong>Available Subjects:</strong>
                        {% if form.subject.field.queryset.exists %}
                            {{ form.subject.field.queryset.count }} subjects
                        {% else %}
                            No existing subjects
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                <form method="post" id="routineForm">
                    {% csrf_token %}

                    <!-- CSRF Token Check -->
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Form Errors:</h6>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% if field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                                {% endif %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if messages %}
                    <div class="messages">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Class *</label>
                                {{ form.class_name }}
                                {% if form.class_name.help_text %}
                                <div class="form-text">{{ form.class_name.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Day *</label>
                                {{ form.day }}
                                {% if form.day.help_text %}
                                <div class="form-text">{{ form.day.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                {{ form.subject }}
                                {% if form.subject.help_text %}
                                <div class="form-text">{{ form.subject.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{{ form.new_subject.label }}</label>
                                {{ form.new_subject }}
                                <div class="form-text">Enter a new subject name if not in the list above</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Start Time *</label>
                                {{ form.start_time }}
                                {% if form.start_time.help_text %}
                                <div class="form-text">{{ form.start_time.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">End Time *</label>
                                {{ form.end_time }}
                                {% if form.end_time.help_text %}
                                <div class="form-text">{{ form.end_time.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Instructions:</h6>
                        <ul class="mb-0">
                            <li>Select the class and day for the routine</li>
                            <li>Either select an existing subject OR enter a new subject name</li>
                            <li>Set the start and end time for the class</li>
                            <li>Ensure end time is after start time</li>
                            <li>Fields marked with * are required</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'class_routine' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-plus"></i> Add Routine
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic form behavior -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('routineForm');
    const subjectSelect = document.querySelector('select[name="subject"]');
    const newSubjectInput = document.querySelector('input[name="new_subject"]');
    const submitBtn = document.getElementById('submitBtn');

    // Show/hide new subject input based on subject selection
    if (subjectSelect && newSubjectInput) {
        subjectSelect.addEventListener('change', function() {
            if (this.value === '') {
                // If no subject selected, show new subject input
                newSubjectInput.style.display = 'block';
                newSubjectInput.required = true;
            } else {
                // If subject selected, hide new subject input
                newSubjectInput.style.display = 'none';
                newSubjectInput.required = false;
                newSubjectInput.value = '';
            }
        });

        // Trigger change event on page load
        subjectSelect.dispatchEvent(new Event('change'));
    }

    // Form submission validation
    form.addEventListener('submit', function(e) {
        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;
        }

        // Basic client-side validation
        const classSelect = document.querySelector('select[name="class_name"]');
        const daySelect = document.querySelector('select[name="day"]');
        const startTime = document.querySelector('input[name="start_time"]');
        const endTime = document.querySelector('input[name="end_time"]');

        let isValid = true;
        let errorMessage = '';

        if (!classSelect.value) {
            isValid = false;
            errorMessage = 'Please select a class';
        } else if (!daySelect.value) {
            isValid = false;
            errorMessage = 'Please select a day';
        } else if (!subjectSelect.value && !newSubjectInput.value) {
            isValid = false;
            errorMessage = 'Please either select a subject or enter a new subject name';
        } else if (!startTime.value) {
            isValid = false;
            errorMessage = 'Please enter start time';
        } else if (!endTime.value) {
            isValid = false;
            errorMessage = 'Please enter end time';
        } else if (startTime.value && endTime.value && startTime.value >= endTime.value) {
            isValid = false;
            errorMessage = 'End time must be after start time';
        }

        if (!isValid) {
            e.preventDefault();
            alert('Error: ' + errorMessage);
            // Reset button state
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Routine';
                submitBtn.disabled = false;
            }
        }
    });
});
</script>

<style>
.select-with-input {
    margin-bottom: 10px;
}

input[name="new_subject"] {
    transition: all 0.3s ease;
}

.form-text {
    font-size: 0.875em;
    color: #6c757d;
}
</style>
{% endblock %}